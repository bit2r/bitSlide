---
title: "후쿠시마 오염수 방류"
subtitle: "경기도 해안선 인접 구시군 영향"
author: "이광춘"
institute: "공익법인 한국 R 사용자회"
date: 2023-07-11
format: 
  insper-revealjs:
    self-contained: false
    footer: |
      한국 R 사용자회 [chatGPT](https://r2bit.com/chatGPT/). theme [insper](https://github.com/padsInsper/quarto-insper-theme) 소스코드 [GitHub](https://github.com/padsInsper/quarto-insper-theme).
date-format: long
lang: ko
filters:
   - lightbox
lightbox: auto
bibliography: bibliography.bib
csl: apa-single-spaced.csl  
editor_options: 
  chunk_output_type: console
---

## 목차

1.  해안선 인접 구시군
1.  경기도 해안선 인접 구시군
1.  경기도 국가/지방 항구
1.  총선, 대선, 지선 선거결과

# 해안선 인접 구시군

## 해안선 {.smaller}

::: {.panel-tabset}

### 대한민국 지도

```{r}
library(sf)
library(giscoR)
library(tidyverse)
library(ggrepel)
library(krvote)
library(gt)
library(gtExtras)
library(janitor)
sf_use_s2(FALSE)

korea_sf <- giscoR::gisco_get_countries(
        year = "2020",
        epsg = "4326",
        resolution = "01",
        country = "KR"
    ) 

plot(st_geometry(korea_sf))
```

### 해안선

```{r}
#| eval: false
# i_world_coastline <- st_read("D:/tcs/map_challenge/data/gshhg-shp-2.3.7/GSHHS_shp/i/GSHHS_i_L1.shp")
# 
# i_coastline_sf <- i_world_coastline %>% 
#   st_crop(st_bbox(korea_sf))

i_coastline_sf <- read_rds("data/i_coastline_sf.rds")

i_coastline_gg <- ggplot(i_coastline_sf) +
  geom_sf(color = "blue", fill = "blue", alpha = 0.2) +
  theme_minimal() +
  theme(
    plot.background = element_rect(
      fill = "black",
      color = "black"
    ),
    panel.grid = element_blank(),
    axis.text = element_text(colour = "grey90")
  )

ragg::agg_png("img/fukushima/i_coastline_gg.png", 
              width = 10, height = 7, units = "in", res = 600)
i_coastline_gg
dev.off()


# i_coastline_sf %>% 
#   write_rds("data/i_coastline_sf.rds")

```

![](img/fukushima/i_coastline_gg.png)

### 결합

```{r}
#| eval: false
# korea_coast_sf <- st_join(korea_sf, i_coastline_sf)

# korea_coast_sf %>%
#   write_rds("data/korea_coast_sf.rds")

korea_coast_sf <- read_rds("data/korea_coast_sf.rds")

korea_coast_gg <- ggplot(korea_coast_sf) +
  geom_sf(color = "black", fill = "transparent", alpha = 0.2) +
  geom_sf(data = i_coastline_sf, color = "blue", fill = "transparent", alpha = 0.2) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_text(colour = "grey90")
  ) 

ragg::agg_png("img/fukushima/korea_coast_gg.png", 
              width = 10, height = 7, units = "in", res = 600)
korea_coast_gg
dev.off()

```

![](img/fukushima/korea_coast_gg.png)


:::

## (21대) 국회의원 선거구 {.smaller}

:::{.panel-tabset}

### 총선 선거구

```{r}
#| eval: false
precinct_sf <- st_read("D:/tcs/map_challenge/data/2020_21_elec_253.json")

kr_precinct_sf <- precinct_sf %>% 
  mutate(SGG_3 = str_remove(SGG_3, pattern = '^\\S*\\s'))

precinct_sf_gg <- ggplot() +
  geom_sf(data = kr_precinct_sf) +
  geom_text_repel(data = kr_precinct_sf %>% filter(!SGG_1 %in% c("서울", "경기", "부산", "인천", "광주", "대전", "대구", "울산")), aes(label = SGG_3, geometry = geometry),
                  stat = "sf_coordinates", min.segment.length = 0,
                  max.overlaps = Inf, size = 2) +
  labs(x = "", y = "")

ragg::agg_png("img/fukushima/precinct_sf_gg.png", 
              width = 10, height = 7, units = "in", res = 600)
precinct_sf_gg
dev.off()
```

![](img/fukushima/precinct_sf_gg.png)


### 해안선 인접 선거구

```{r}
#| eval: false
kr_coast_sf <- st_filter(precinct_sf, i_coastline_sf, .predicate = st_overlaps)

precinct_coast_gg <- ggplot() +
  geom_sf(data = kr_coast_sf) +
  geom_sf(data = korea_coast_sf, color = "blue", fill = "transparent") +
  geom_text_repel(data = kr_coast_sf, aes(label = SGG_3, geometry = geometry),
                   stat = "sf_coordinates", min.segment.length = 0, size = 3, 
                   max.overlaps = Inf, box.padding = 1.0) +
  labs(x = "",
       y = "")

ragg::agg_png("img/fukushima/precinct_coast_gg.png", 
              width = 10, height = 7, units = "in", res = 600)
precinct_coast_gg
dev.off()

```

![](img/fukushima/precinct_coast_gg.png)

:::


## 경기도 {.smaller}

:::{.panel-tabset}

### 선거구

```{r}
#| eval: false

gg_precinct_sf <- precinct_sf %>% 
  filter(SGG_1 == "경기") %>% 
  mutate(SGG_3 = str_remove(SGG_3, "경기\\s+")) 

gg_precinct_gg <- ggplot() +
  geom_sf(data = gg_precinct_sf) +
  geom_text_repel(data = gg_precinct_sf, aes(label = SGG_3, geometry = geometry),
                  stat = "sf_coordinates", min.segment.length = 0,
                  max.overlaps = Inf, size =2) +
  labs(x="", y="")

ragg::agg_png("img/fukushima/gg_precinct_gg.png", 
              width = 10, height = 7, units = "in", res = 600)
gg_precinct_gg
dev.off()

```

![](img/fukushima/gg_precinct_gg.png)

### 해안선 인접 선거구

```{r}
#| eval: false

gg_coast_sf <- st_filter(gg_precinct_sf, i_coastline_sf, .predicate = st_overlaps)

gg_coast_gg <- ggplot() +
  geom_sf(data = gg_coast_sf) +
  geom_sf(data = gg_precinct_sf, color = "blue", fill = "transparent") +
  geom_text_repel(data = gg_coast_sf, aes(label = SGG_3, geometry = geometry),
                   stat = "sf_coordinates", min.segment.length = 0, size = 3, 
                   max.overlaps = Inf, box.padding = 1.0) +
  labs(x = "",
       y = "")

ragg::agg_png("img/fukushima/gg_coast_gg.png", 
              width = 10, height = 7, units = "in", res = 600)
gg_coast_gg
dev.off()
```

![](img/fukushima/gg_coast_gg.png)


### 선거구명

```{r}
# gg_coast_sf %>% 
#   write_rds("data/gg_coast_sf.rds")

gg_coast_sf <- read_rds("data/gg_coast_sf.rds")

gg_coast_sf %>% 
  sf::st_drop_geometry() %>% 
  mutate(SGG_3 = str_remove(SGG_3, pattern = '^\\S*\\s')) %>% 
  mutate(순 = 1:n()) %>% 
  select(-SGG_2) %>% 
  select(순, everything()) %>% 
  gt::gt() %>% 
    cols_align(align = "center") %>% 
    tab_header(title = "해안선 인접 총선 선거구",
               subtitle = md("`선관위 제21대 선거구 기준`")) %>% 
    cols_label(
      SGG_Code = "시군구 코드",
      SGG_1 = "시도명",
      SGG_3 = "선거구명"
    ) %>% 
    gt_theme_538() 
```

:::


## 항구

```{r}
#| eval: false

admin_sf <- st_read("D:/tcs/map_challenge/data/HangJeongDong_ver20230401.geojson")

gg_incheon_sf <- admin_sf %>% 
  filter(sidonm %in% c("경기도")) %>% 
  group_by(sidonm, sggnm) %>% 
  summarize(geometry = st_union(geometry)) %>% 
  mutate(바다인접 = ifelse(str_detect(sggnm, "김포|안산|화성|평택|시흥"), "바다인접", "비인접")) %>% 
  ungroup()

ggport_geo <- read_rds("D:/tcs/map_challenge/data/ggport_geo.rds") %>% 
  select(-data, - lonlat) %>% 
  add_row("어항_명" = "평택항", "어항_종류" = "국가어항", "주소" = "경기도 평택시 포승읍 평택항만길 73", "lon" = 126.8483825, "lat" = 36.9574197)

ggport_geo_sf <- ggport_geo %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4326, agr = "constant")

gg_port_gg <- ggplot() +
  geom_sf(data = gg_incheon_sf, aes(fill = 바다인접), linewidth = 0.1, show.legend = FALSE) +
  geom_sf(data = ggport_geo_sf, aes(color = 어항_종류)) +
  ggrepel::geom_text_repel(
    data = ggport_geo_sf,
      aes(label = 어항_명, geometry = geometry), stat = "sf_coordinates", 
      min.segment.length = 1, size = 3
    ) +
    theme_void() +
    labs(title = "경기도 국가/지방어항 현황",
         color = "어항 종류") +
    ggrepel::geom_text_repel(
      data = gg_incheon_sf,
      aes(label = sggnm, geometry = geometry), stat = "sf_coordinates", 
      min.segment.length = 1, size = 3, show.legend = FALSE
    )   +
    scale_fill_manual(values = c("skyblue", "gray95")) +  
    scale_color_manual(values = c("지방어항" = "blue", "국가어항" = "red",
                                  "바다인접" = "black", "비인접" = "orange")) 

ragg::agg_png("img/fukushima/gg_port_gg.png", 
              width = 10, height = 7, units = "in", res = 600)
gg_port_gg
dev.off()


```

![](img/fukushima/gg_port_gg.png)

# 5 구시군 투개표

## 총선 (2020년)

:::{.panel-tabset}

### 득표수

```{r}
library(stringi)

general_sgg <- krvote::general_2020 %>% 
  filter( str_detect(시도, "^경기"),
          str_detect(선거구, "^화성|^평택|^김포|^안산시단원구|^시흥")) 

general_sgg_table <- general_sgg %>% 
  unnest(data) %>% 
  ## CP949 인코딩 처리
  mutate(구분_cp949  = iconv(구분, "euc-kr", "utf-8")) %>% 
  mutate(구분 = ifelse(is.na(구분_cp949), 구분, 구분_cp949)) %>% 
  group_by(선거구, 구분) %>% 
  summarise( 득표 = sum(사람수)) %>% 
  filter(구분 != "무표투표수",
         구분 != "기권수",
         구분 != "선거인수",
         구분 != "투표수",
         구분 != "계") %>% 
  ungroup() %>% 
  mutate(구분 = case_when( str_detect(구분, "민주당") ~ "민주당",
                           str_detect(구분, "미래통합") ~ "국민의힘",
                           TRUE ~ "기타")) %>% 
  group_by(선거구, 구분) %>% 
  summarise(득표 = sum(득표)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = 구분, values_from = 득표) %>% 
  janitor::adorn_totals(where = "col", name = "합계") 

general_sgg_table %>% 
  relocate(기타, .before = 합계) %>% 
  gt() %>% 
    fmt_integer(columns = 국민의힘:합계) %>% 
    cols_align(columns = 선거구, align = "center") %>% 
    tab_spanner(
      label = "대선 후보 정당",
      columns = c(국민의힘, 민주당, 기타)
  ) %>% 
    gt_theme_538() %>% 
    tab_header(
      title = md("경기도 서해 인접 5개 구시군 정당별 득표"),
      subtitle = md("`제21대 국회의원선거`")
  )  %>% 
  tab_style(
    style = list(cell_fill(color = "blue"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 민주당,
                           rows = 민주당 > 국민의힘)
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "red"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 국민의힘,
                           rows = 민주당 < 국민의힘)
  )

```


### 득표율

```{r}
general_sgg_table %>% 
  adorn_percentages() %>% 
  gt::gt() %>% 
    fmt_percent(columns = 국민의힘:합계, decimals = 1) %>% 
    cols_align(columns = 선거구, align = "center") %>% 
    tab_spanner(
      label = "대선 후보 정당",
      columns = c(국민의힘, 민주당, 기타)
  ) %>% 
    gt_theme_538() %>% 
    tab_header(
      title = md("경기도 서해 인접 5개 구시군 정당별 득표율(%)"),
      subtitle = md("`제21대 국회의원선거`")
  )  %>% 
  tab_style(
    style = list(cell_fill(color = "blue"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 민주당,
                           rows = 민주당 > 국민의힘)
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "red"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 국민의힘,
                           rows = 민주당 < 국민의힘)
  )
```

:::


## 대선 (2022년)

:::{.panel-tabset}

### 득표수

```{r}
library(krvote)
library(janitor)
library(gt)
library(gtExtras)

ggport_sgg <- krvote::election_20220309$득표율 %>% 
  filter( str_detect(시도명, "^경기"),
          str_detect(구시군명, "^화성|^평택|^김포|^안산시단원구|^시흥")) 
  
ggport_sgg_table <- ggport_sgg %>% 
  pivot_longer(이재명:계, names_to = "후보", values_to = "득표") %>% 
  group_by(구시군명, 후보) %>% 
  summarise(득표 = sum(득표)) %>% 
  filter(후보 != "계") %>% 
  ungroup() %>% 
  mutate(후보 = case_when( 후보 == "윤석열" ~ "국민의힘",
                           후보 == "이재명" ~ "민주당",
                           TRUE ~ "기타")) %>% 
  group_by(구시군명, 후보) %>% 
  summarise( 득표 = sum(득표)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = 후보, values_from = 득표) %>% 
  janitor::adorn_totals(where = "col", name = "합계") 


ggport_sgg_table %>% 
  relocate(기타, .before = 합계) %>% 
  gt() %>% 
    fmt_integer(columns = 국민의힘:합계) %>% 
    cols_align(columns = 구시군명, align = "center") %>% 
    tab_spanner(
      label = "대선 후보 정당",
      columns = c(국민의힘, 민주당, 기타)
  ) %>% 
    gt_theme_538() %>% 
    tab_header(
      title = md("경기도 서해 인접 5개 구시군 정당별 득표"),
      subtitle = md("`제20대 대통령선거`")
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "blue"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 민주당,
                           rows = 민주당 > 국민의힘)
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "red"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 국민의힘,
                           rows = 민주당 < 국민의힘)
  )

```

### 득표율

```{r}
ggport_sgg_table %>% 
  adorn_percentages() %>% 
  gt::gt() %>% 
    fmt_percent(columns = 국민의힘:합계, decimals = 1) %>% 
    cols_align(columns = 구시군명, align = "center") %>% 
    tab_spanner(
      label = "대선 후보 정당",
      columns = c(국민의힘, 민주당, 기타)
  ) %>% 
    gt_theme_538() %>% 
    tab_header(
      title = md("경기도 서해 인접 5개 구시군 정당별 득표율(%)"),
      subtitle = md("`제20대 대통령선거`")
  )   %>% 
  tab_style(
    style = list(cell_fill(color = "blue"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 민주당,
                           rows = 민주당 > 국민의힘)
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "red"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 국민의힘,
                           rows = 민주당 < 국민의힘)
  )
```


:::




## 지선 - 도지사 (2022년)

:::{.panel-tabset}

### 득표수

```{r}
local_sido_raw <- krvote::local_sido_20220601 %>% 
  filter(str_detect(선거구명, "^경기")) %>% 
  unnest(data) %>% 
  filter(str_detect(구시군명, "^화성|^평택|^김포|^안산시단원구|^시흥")) %>% 
  pivot_longer(더불어민주당_김동연:기권수) %>% 
  separate(name, into = c("정당", "후보"), sep = "_") %>% 
  filter(!is.na(후보)) %>% 
  group_by(구시군명, 정당) %>% 
  summarise(득표 = sum(value)) %>% 
  ungroup()

local_sido_table <- local_sido_raw %>% 
  mutate(정당 = case_when( str_detect(정당, "민주당") ~ "민주당",
                           str_detect(정당, "국민의힘") ~ "국민의힘",
                           TRUE ~ "기타")) %>% 
  group_by(구시군명, 정당) %>% 
  summarise(득표 = sum(득표)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = 정당, values_from = 득표) %>% 
  janitor::adorn_totals(where = "col", name = "합계") 

local_sido_table %>% 
  relocate(기타, .before = 합계) %>% 
  gt() %>% 
    fmt_integer(columns = 국민의힘:합계) %>% 
    cols_align(columns = 구시군명, align = "center") %>% 
    tab_spanner(
      label = "지방선거 도지사 후보 정당",
      columns = c(국민의힘, 민주당, 기타)
  ) %>% 
    gt_theme_538() %>% 
    tab_header(
      title = md("경기도 서해 인접 5개 구시군 정당별 득표"),
      subtitle = md("`제8대 지방선거`")
  )  %>% 
  tab_style(
    style = list(cell_fill(color = "blue"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 민주당,
                           rows = 민주당 > 국민의힘)
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "red"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 국민의힘,
                           rows = 민주당 < 국민의힘)
  )
```


### 득표율

```{r}
local_sido_table %>% 
  adorn_percentages() %>% 
  gt::gt() %>% 
    fmt_percent(columns = 국민의힘:합계, decimals = 1) %>% 
    cols_align(columns = 구시군명, align = "center") %>% 
    tab_spanner(
      label = "지방선거 도지사 후보 정당",
      columns = c(국민의힘, 민주당, 기타)
  ) %>% 
    gt_theme_538() %>% 
    tab_header(
      title = md("경기도 서해 인접 5개 구시군 정당별 득표"),
      subtitle = md("`제8대 지방선거`")
  )  %>% 
  tab_style(
    style = list(cell_fill(color = "blue"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 민주당,
                           rows = 민주당 > 국민의힘)
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "red"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 국민의힘,
                           rows = 민주당 < 국민의힘)
  )
```

:::


## 지선 - 구시군장 (2022년)

:::{.panel-tabset}

### 득표수

```{r}
local_sgg_raw <- krvote::local_sgg_20220601 %>% 
  filter(str_detect(시도명, "^경기")) %>% 
  filter(str_detect(구시군명, "^화성|^평택|^김포|^안산|^시흥")) %>% 
  mutate(득표 = parse_number(득표)) %>% 
  group_by(구시군명, 정당) %>% 
  summarise(득표 = sum(득표)) %>% 
  ungroup()

local_sgg_table <- local_sgg_raw %>% 
  mutate(정당 = case_when( str_detect(정당, "민주당") ~ "민주당",
                           str_detect(정당, "국민의힘") ~ "국민의힘",
                           TRUE ~ "기타")) %>% 
  group_by(구시군명, 정당) %>% 
  summarise(득표 = sum(득표, na.rm = TRUE)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = 정당, values_from = 득표, values_fill = 0) %>% 
  janitor::adorn_totals(where = "col", name = "합계") 

local_sgg_table %>% 
  relocate(기타, .before = 합계) %>% 
  gt() %>% 
    fmt_integer(columns = 국민의힘:합계) %>% 
    cols_align(columns = 구시군명, align = "center") %>% 
    tab_spanner(
      label = "지방선거 구시군의 장 후보 정당",
      columns = c(국민의힘, 민주당, 기타)
  ) %>% 
    gt_theme_538() %>% 
    tab_header(
      title = md("경기도 서해 인접 5개 구시군 정당별 득표"),
      subtitle = md("`제8대 지방선거`")
  )  %>% 
  tab_style(
    style = list(cell_fill(color = "blue"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 민주당,
                           rows = 민주당 > 국민의힘)
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "red"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 국민의힘,
                           rows = 민주당 < 국민의힘)
  )
```


### 득표율

```{r}
local_sgg_table %>% 
  adorn_percentages() %>% 
  gt::gt() %>% 
    fmt_percent(columns = 국민의힘:합계, decimals = 1) %>% 
    cols_align(columns = 구시군명, align = "center") %>% 
    tab_spanner(
      label = "지방선거 구시군의 장 후보 정당",
      columns = c(국민의힘, 민주당, 기타)
  ) %>% 
    gt_theme_538() %>% 
    tab_header(
      title = md("경기도 서해 인접 5개 구시군 정당별 득표"),
      subtitle = md("`제8대 지방선거`")
  )  %>% 
  tab_style(
    style = list(cell_fill(color = "blue"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 민주당,
                           rows = 민주당 > 국민의힘)
  ) %>% 
  tab_style(
    style = list(cell_fill(color = "red"),
                 cell_text(color = "white")),
    locations = cells_body(columns = 국민의힘,
                           rows = 민주당 < 국민의힘)
  )
```

:::


